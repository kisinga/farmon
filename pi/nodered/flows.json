[
    {
        "id": "0a00ea51f19dcb75",
        "type": "tab",
        "label": "Dashboard",
        "disabled": false,
        "info": "UIBuilder dashboard handlers"
    },
    {
        "id": "7e7308018823ce78",
        "type": "tab",
        "label": "Message Router",
        "disabled": false,
        "info": "Routes ChirpStack messages by fPort"
    },
    {
        "id": "72aa6c226990e117",
        "type": "global-config",
        "env": [],
        "modules": {
            "node-red-contrib-postgresql": "0.15.4",
            "node-red-contrib-uibuilder": "7.5.0"
        }
    },
    {
        "id": "pg-config",
        "type": "postgreSQLConfig",
        "name": "FarmMon DB",
        "host": "postgres",
        "port": "5432",
        "database": "farmmon",
        "ssl": false,
        "max": "10",
        "idle": "1000",
        "connectionTimeout": "10000",
        "user": "farmmon",
        "password": "farmmon"
    },
    {
        "id": "e1b2c3d4e5f6a7b8",
        "type": "mqtt-broker",
        "name": "Mosquitto",
        "broker": "mosquitto",
        "port": "1883",
        "clientid": "nodered-farm",
        "autoConnect": true,
        "usetls": false,
        "protocolVersion": "4",
        "keepalive": "60",
        "cleansession": true,
        "autoUnsubscribe": true,
        "birthTopic": "",
        "birthQos": "0",
        "birthPayload": "",
        "birthMsg": {},
        "closeTopic": "",
        "closeQos": "0",
        "closePayload": "",
        "closeMsg": {},
        "willTopic": "",
        "willQos": "0",
        "willPayload": "",
        "willMsg": {},
        "userProps": "",
        "sessionExpiry": ""
    },
    {
        "id": "6303b240ed51a34e",
        "type": "link in",
        "z": "0a00ea51f19dcb75",
        "name": "From Handlers",
        "links": [],
        "x": 275,
        "y": 200,
        "wires": [
            [
                "fe9ff61fa70ce0eb"
            ]
        ]
    },
    {
        "id": "1961d947f0695190",
        "type": "switch",
        "z": "0a00ea51f19dcb75",
        "name": "Route by Topic",
        "property": "topic",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "getDevices",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "selectDevice",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "getHistory",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "setControl",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "clearOverride",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "getRules",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "saveRule",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "deleteRule",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "saveTrigger",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 9,
        "x": 680,
        "y": 200,
        "wires": [
            [
                "9ae591084f9c6ad7"
            ],
            [
                "2610fa8ff2269aa6"
            ],
            [
                "75af3011f0d945aa"
            ],
            [
                "31efc664d10efb1d"
            ],
            [
                "dc156d11326bc2a6"
            ],
            [
                "94ab90c9284a8612"
            ],
            [
                "b79f93905c704911"
            ],
            [
                "0676f7b01b29b217"
            ],
            [
                "e02a55b4e84b228c"
            ]
        ]
    },
    {
        "id": "9ae591084f9c6ad7",
        "type": "postgresql",
        "z": "0a00ea51f19dcb75",
        "name": "Get Devices",
        "query": "SELECT device_eui as eui, device_name as name, device_type as type, last_seen as \"lastSeen\" FROM devices WHERE is_active = true ORDER BY last_seen DESC",
        "postgreSQLConfig": "pg-config",
        "split": false,
        "rowsPerMsg": 1,
        "outputs": 1,
        "x": 910,
        "y": 80,
        "wires": [
            [
                "eb3deb59b1fa997e"
            ]
        ]
    },
    {
        "id": "eb3deb59b1fa997e",
        "type": "function",
        "z": "0a00ea51f19dcb75",
        "name": "Format Devices",
        "func": "const devices = Array.isArray(msg.payload) ? msg.payload : [];\nreturn {\n    topic: 'devices',\n    payload: devices\n};",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1100,
        "y": 80,
        "wires": [
            [
                "fe9ff61fa70ce0eb"
            ]
        ]
    },
    {
        "id": "2610fa8ff2269aa6",
        "type": "function",
        "z": "0a00ea51f19dcb75",
        "name": "Prepare Query",
        "func": "const eui = msg.payload?.eui;\nif (!eui) return null;\n\nmsg.params = [eui];\nflow.set('selectedDevice', eui);\nflow.set('selectedRange', msg.payload?.range || '24h');\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 910,
        "y": 140,
        "wires": [
            [
                "c9b9b102e3b1af94"
            ]
        ]
    },
    {
        "id": "c9b9b102e3b1af94",
        "type": "postgresql",
        "z": "0a00ea51f19dcb75",
        "name": "Get Fields + Viz",
        "query": "SELECT \n    f.field_key as key,\n    f.display_name as name,\n    f.data_type as type,\n    f.unit,\n    f.category,\n    f.min_value as min,\n    f.max_value as max,\n    f.enum_values,\n    v.viz_type,\n    v.gauge_style,\n    v.chart_color,\n    v.thresholds,\n    v.is_visible,\n    v.sort_order\nFROM device_fields f\nLEFT JOIN viz_config v ON f.device_eui = v.device_eui AND f.field_key = v.field_key\nWHERE f.device_eui = $1\nORDER BY v.sort_order, f.field_key",
        "postgreSQLConfig": "pg-config",
        "split": false,
        "rowsPerMsg": 1,
        "outputs": 1,
        "x": 1110,
        "y": 140,
        "wires": [
            [
                "07031c7c03d3bc88"
            ]
        ]
    },
    {
        "id": "07031c7c03d3bc88",
        "type": "function",
        "z": "0a00ea51f19dcb75",
        "name": "Store Fields",
        "func": "msg.fields = msg.payload;\nmsg.params = [msg.params[0]];\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1290,
        "y": 140,
        "wires": [
            [
                "c8d63f073a751d02"
            ]
        ]
    },
    {
        "id": "c8d63f073a751d02",
        "type": "postgresql",
        "z": "0a00ea51f19dcb75",
        "name": "Get Controls",
        "query": "SELECT control_key as key, current_state as state, mode, manual_until, last_change_at, last_change_by\nFROM device_controls WHERE device_eui = $1",
        "postgreSQLConfig": "pg-config",
        "split": false,
        "rowsPerMsg": 1,
        "outputs": 1,
        "x": 1470,
        "y": 140,
        "wires": [
            [
                "b67fe7a184262d8a"
            ]
        ]
    },
    {
        "id": "b67fe7a184262d8a",
        "type": "function",
        "z": "0a00ea51f19dcb75",
        "name": "Store Controls",
        "func": "msg.controls = msg.payload;\nmsg.params = [msg.params[0]];\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1640,
        "y": 140,
        "wires": [
            [
                "0dd8dbfc27658a86"
            ]
        ]
    },
    {
        "id": "0dd8dbfc27658a86",
        "type": "postgresql",
        "z": "0a00ea51f19dcb75",
        "name": "Get Triggers",
        "query": "SELECT trigger_key as key, display_name as name, field_key as field, operator as op, threshold as th, action_control as ctrl, action_state as st, enabled\nFROM device_triggers WHERE device_eui = $1",
        "postgreSQLConfig": "pg-config",
        "split": false,
        "rowsPerMsg": 1,
        "outputs": 1,
        "x": 1810,
        "y": 140,
        "wires": [
            [
                "5894067ac046904f"
            ]
        ]
    },
    {
        "id": "5894067ac046904f",
        "type": "function",
        "z": "0a00ea51f19dcb75",
        "name": "Store Triggers",
        "func": "msg.triggers = msg.payload;\nmsg.params = [msg.params[0]];\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1980,
        "y": 140,
        "wires": [
            [
                "ec7f9863d3f924dd"
            ]
        ]
    },
    {
        "id": "ec7f9863d3f924dd",
        "type": "postgresql",
        "z": "0a00ea51f19dcb75",
        "name": "Get Latest Telemetry",
        "query": "SELECT data, rssi, snr, ts FROM telemetry WHERE device_eui = $1 ORDER BY ts DESC LIMIT 1",
        "postgreSQLConfig": "pg-config",
        "split": false,
        "rowsPerMsg": 1,
        "outputs": 1,
        "x": 940,
        "y": 200,
        "wires": [
            [
                "31649829f4c237f3"
            ]
        ]
    },
    {
        "id": "31649829f4c237f3",
        "type": "function",
        "z": "0a00ea51f19dcb75",
        "name": "Format Config",
        "func": "const latest = msg.payload?.[0];\n\nreturn {\n    topic: 'deviceConfig',\n    payload: {\n        eui: msg.params[0],\n        fields: msg.fields,\n        controls: msg.controls,\n        triggers: msg.triggers,\n        current: latest ? {\n            data: latest.data,\n            rssi: latest.rssi,\n            snr: latest.snr,\n            ts: latest.ts\n        } : null\n    }\n};",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1150,
        "y": 200,
        "wires": [
            [
                "fe9ff61fa70ce0eb"
            ]
        ]
    },
    {
        "id": "75af3011f0d945aa",
        "type": "function",
        "z": "0a00ea51f19dcb75",
        "name": "Build History Query",
        "func": "const eui = msg.payload?.eui || flow.get('selectedDevice');\nconst field = msg.payload?.field;\nconst range = msg.payload?.range || flow.get('selectedRange') || '24h';\n\nif (!eui || !field) return null;\n\nconst intervals = {\n    '1h': '1 hour',\n    '6h': '6 hours',\n    '24h': '24 hours',\n    '7d': '7 days',\n    '30d': '30 days'\n};\n\nconst interval = intervals[range] || '24 hours';\n\nmsg.params = [eui, interval];\nmsg.field = field;\n\n// Handle special fields that are columns, not in JSONB data\nif (field === 'rssi') {\n    msg.query = `SELECT ts, rssi::numeric as value\nFROM telemetry\nWHERE device_eui = $1 AND ts > NOW() - $2::interval AND rssi IS NOT NULL\nORDER BY ts`;\n} else if (field === 'snr') {\n    msg.query = `SELECT ts, snr::numeric as value\nFROM telemetry\nWHERE device_eui = $1 AND ts > NOW() - $2::interval AND snr IS NOT NULL\nORDER BY ts`;\n} else {\n    msg.query = `SELECT ts, (data->>'${field}')::numeric as value\nFROM telemetry\nWHERE device_eui = $1 AND ts > NOW() - $2::interval AND data->>'${field}' IS NOT NULL\nORDER BY ts`;\n}\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 930,
        "y": 260,
        "wires": [
            [
                "532ebdfd3f6c8805"
            ]
        ]
    },
    {
        "id": "532ebdfd3f6c8805",
        "type": "postgresql",
        "z": "0a00ea51f19dcb75",
        "name": "Execute",
        "query": "",
        "postgreSQLConfig": "pg-config",
        "split": false,
        "rowsPerMsg": 1,
        "outputs": 1,
        "x": 1110,
        "y": 260,
        "wires": [
            [
                "5d90bbeb0d2b2d75"
            ]
        ]
    },
    {
        "id": "5d90bbeb0d2b2d75",
        "type": "function",
        "z": "0a00ea51f19dcb75",
        "name": "Format History",
        "func": "return {\n    topic: 'history',\n    payload: {\n        eui: msg.params[0],\n        field: msg.field,\n        data: msg.payload.map(r => ({ ts: r.ts, value: r.value }))\n    }\n};",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1280,
        "y": 260,
        "wires": [
            [
                "fe9ff61fa70ce0eb"
            ]
        ]
    },
    {
        "id": "31efc664d10efb1d",
        "type": "function",
        "z": "0a00ea51f19dcb75",
        "name": "Set Manual Control",
        "func": "const { eui, control, state, duration } = msg.payload;\n\nif (!eui || !control || !state) return null;\n\n// Calculate manual_until if duration specified\nlet manualUntil = null;\nif (duration) {\n    manualUntil = new Date(Date.now() + duration * 60 * 1000);\n}\n\nmsg.params = [state, 'manual', manualUntil, 'user', eui, control];\nmsg.controlInfo = { eui, control, state };\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 930,
        "y": 320,
        "wires": [
            [
                "c55c7864b5915d73"
            ]
        ]
    },
    {
        "id": "c55c7864b5915d73",
        "type": "postgresql",
        "z": "0a00ea51f19dcb75",
        "name": "Update Control",
        "query": "UPDATE device_controls SET current_state = $1, mode = $2, manual_until = $3, last_change_by = $4, last_change_at = NOW()\nWHERE device_eui = $5 AND control_key = $6\nRETURNING *",
        "postgreSQLConfig": "pg-config",
        "split": false,
        "rowsPerMsg": 1,
        "outputs": 1,
        "x": 1130,
        "y": 320,
        "wires": [
            [
                "4d2588f6d6a8163a"
            ]
        ]
    },
    {
        "id": "4d2588f6d6a8163a",
        "type": "function",
        "z": "0a00ea51f19dcb75",
        "name": "Build & Send Downlink",
        "func": "const { eui, control, state } = msg.controlInfo;\n\n// Get command port from device registration\n// For now, use defaults\nconst commandPorts = {\n    'pump': 20,\n    'valve': 21\n};\n\nconst port = commandPorts[control] || 20;\nconst stateValue = (state === 'on' || state === 'open') ? 0x01 : 0x00;\n\n// Log command\nmsg.cmdParams = [eui, `set_${control}`, JSON.stringify({state}), 'user', 'sent'];\n\n// Build downlink - set topic and payload directly for mqtt out node\nconst appId = global.get('chirpstackAppId') || '885c4dd2-e474-4265-bd25-2f838571f8de';\n\nmsg.topic = `application/${appId}/device/${eui}/command/down`;\nmsg.payload = {\n    devEui: eui,\n    confirmed: false,\n    fPort: port,\n    data: Buffer.from([stateValue]).toString('base64')\n};\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1360,
        "y": 320,
        "wires": [
            [
                "ebb226ff791f8991",
                "c837752a6f60d7b5",
                "ea6528910208629b"
            ]
        ]
    },
    {
        "id": "ebb226ff791f8991",
        "type": "postgresql",
        "z": "0a00ea51f19dcb75",
        "name": "Log Command",
        "query": "INSERT INTO commands (device_eui, command_key, payload, initiated_by, status, sent_at)\nVALUES ($1, $2, $3::jsonb, $4, $5, NOW())",
        "postgreSQLConfig": "pg-config",
        "split": false,
        "rowsPerMsg": 1,
        "outputs": 1,
        "x": 1590,
        "y": 280,
        "wires": [
            []
        ]
    },
    {
        "id": "c837752a6f60d7b5",
        "type": "mqtt out",
        "z": "0a00ea51f19dcb75",
        "name": "Send Downlink",
        "topic": "",
        "qos": "",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "e1b2c3d4e5f6a7b8",
        "x": 1600,
        "y": 320,
        "wires": []
    },
    {
        "id": "ea6528910208629b",
        "type": "function",
        "z": "0a00ea51f19dcb75",
        "name": "Notify UI",
        "func": "const { eui, control, state } = msg.controlInfo;\nreturn {\n    topic: 'stateChange',\n    payload: {\n        eui,\n        control,\n        state,\n        reason: 'user'\n    }\n};",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1590,
        "y": 360,
        "wires": [
            [
                "fe9ff61fa70ce0eb"
            ]
        ]
    },
    {
        "id": "dc156d11326bc2a6",
        "type": "function",
        "z": "0a00ea51f19dcb75",
        "name": "Clear Override",
        "func": "const { eui, control } = msg.payload;\n\nif (!eui || !control) return null;\n\nmsg.params = ['auto', eui, control];\nmsg.controlInfo = { eui, control };\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 920,
        "y": 380,
        "wires": [
            [
                "4b100331c466fa31"
            ]
        ]
    },
    {
        "id": "4b100331c466fa31",
        "type": "postgresql",
        "z": "0a00ea51f19dcb75",
        "name": "Set Auto Mode",
        "query": "UPDATE device_controls SET mode = $1, manual_until = NULL WHERE device_eui = $2 AND control_key = $3 RETURNING *",
        "postgreSQLConfig": "pg-config",
        "split": false,
        "rowsPerMsg": 1,
        "outputs": 1,
        "x": 1110,
        "y": 380,
        "wires": [
            [
                "fb256b7a72f44ec9"
            ]
        ]
    },
    {
        "id": "fb256b7a72f44ec9",
        "type": "function",
        "z": "0a00ea51f19dcb75",
        "name": "Notify UI",
        "func": "const ctrl = msg.payload?.[0];\nif (!ctrl) return null;\n\nreturn {\n    topic: 'controlUpdate',\n    payload: {\n        eui: msg.controlInfo.eui,\n        control: ctrl.control_key,\n        state: ctrl.current_state,\n        mode: ctrl.mode\n    }\n};",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1290,
        "y": 380,
        "wires": [
            [
                "fe9ff61fa70ce0eb"
            ]
        ]
    },
    {
        "id": "f7bbe8cc31a3dbbd",
        "type": "function",
        "z": "0a00ea51f19dcb75",
        "name": "On Client Connect",
        "func": "if (msg.uibuilderCtrl === 'client connect') {\n    return { topic: 'getDevices' };\n}\nreturn null;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 690,
        "y": 80,
        "wires": [
            [
                "9ae591084f9c6ad7"
            ]
        ]
    },
    {
        "id": "5e8f9e66c6cb1049",
        "type": "inject",
        "z": "0a00ea51f19dcb75",
        "name": "Every 60s",
        "props": [],
        "repeat": "60",
        "crontab": "",
        "once": true,
        "onceDelay": "10",
        "topic": "",
        "x": 130,
        "y": 440,
        "wires": [
            [
                "b0c155b053f43cf0"
            ]
        ]
    },
    {
        "id": "b0c155b053f43cf0",
        "type": "postgresql",
        "z": "0a00ea51f19dcb75",
        "name": "Expire Manual Overrides",
        "query": "UPDATE device_controls\nSET mode = 'auto', manual_until = NULL\nWHERE mode = 'manual' AND manual_until < NOW()\nRETURNING device_eui, control_key, current_state",
        "postgreSQLConfig": "pg-config",
        "split": false,
        "rowsPerMsg": 1,
        "outputs": 1,
        "x": 340,
        "y": 440,
        "wires": [
            [
                "d67a4d619f5e25fc"
            ]
        ]
    },
    {
        "id": "d67a4d619f5e25fc",
        "type": "function",
        "z": "0a00ea51f19dcb75",
        "name": "Notify UI",
        "func": "const expired = msg.payload || [];\nif (expired.length === 0) return null;\n\n// Send control update for each expired override\nconst msgs = expired.map(c => ({\n    topic: 'controlUpdate',\n    payload: {\n        eui: c.device_eui,\n        control: c.control_key,\n        state: c.current_state,\n        mode: 'auto'\n    }\n}));\n\nreturn [msgs];",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 570,
        "y": 440,
        "wires": [
            [
                "fe9ff61fa70ce0eb"
            ]
        ]
    },
    {
        "id": "94ab90c9284a8612",
        "type": "function",
        "z": "0a00ea51f19dcb75",
        "name": "Prepare Rules Query",
        "func": "const eui = msg.payload?.eui;\nif (!eui) return null;\nmsg.params = [eui];\nmsg.deviceEui = eui;\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 930,
        "y": 500,
        "wires": [
            [
                "26f7c7849dbd262c"
            ]
        ]
    },
    {
        "id": "26f7c7849dbd262c",
        "type": "postgresql",
        "z": "0a00ea51f19dcb75",
        "name": "Get All Rules",
        "query": "SELECT id, name, description, condition, action_control, action_state, priority, cooldown_seconds, enabled, last_triggered, created_at\nFROM user_rules WHERE device_eui = $1 ORDER BY priority, created_at",
        "postgreSQLConfig": "pg-config",
        "split": false,
        "rowsPerMsg": 1,
        "outputs": 1,
        "x": 1130,
        "y": 500,
        "wires": [
            [
                "3bd3438f9b9c5c13"
            ]
        ]
    },
    {
        "id": "3bd3438f9b9c5c13",
        "type": "function",
        "z": "0a00ea51f19dcb75",
        "name": "Format Rules",
        "func": "return {\n    topic: 'rules',\n    payload: {\n        eui: msg.deviceEui,\n        rules: msg.payload || []\n    }\n};",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1300,
        "y": 500,
        "wires": [
            [
                "fe9ff61fa70ce0eb"
            ]
        ]
    },
    {
        "id": "b79f93905c704911",
        "type": "function",
        "z": "0a00ea51f19dcb75",
        "name": "Build Rule Upsert",
        "func": "const rule = msg.payload;\nif (!rule || !rule.eui) return null;\n\n// If rule has id, it's an update\nif (rule.id) {\n    msg.query = `UPDATE user_rules SET\n        name = $2, description = $3, condition = $4::jsonb,\n        action_control = $5, action_state = $6, priority = $7,\n        cooldown_seconds = $8, enabled = $9\n    WHERE id = $1 AND device_eui = $10\n    RETURNING *`;\n    msg.params = [\n        rule.id, rule.name, rule.description || null,\n        JSON.stringify(rule.condition), rule.action_control, rule.action_state,\n        rule.priority || 100, rule.cooldown_seconds || 300, rule.enabled ?? true,\n        rule.eui\n    ];\n} else {\n    msg.query = `INSERT INTO user_rules\n        (device_eui, name, description, condition, action_control, action_state, priority, cooldown_seconds, enabled)\n    VALUES ($1, $2, $3, $4::jsonb, $5, $6, $7, $8, $9)\n    RETURNING *`;\n    msg.params = [\n        rule.eui, rule.name, rule.description || null,\n        JSON.stringify(rule.condition), rule.action_control, rule.action_state,\n        rule.priority || 100, rule.cooldown_seconds || 300, rule.enabled ?? true\n    ];\n}\n\nmsg.deviceEui = rule.eui;\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 920,
        "y": 560,
        "wires": [
            [
                "51677dc0a8729abd"
            ]
        ]
    },
    {
        "id": "51677dc0a8729abd",
        "type": "postgresql",
        "z": "0a00ea51f19dcb75",
        "name": "Execute",
        "query": "",
        "postgreSQLConfig": "pg-config",
        "split": false,
        "rowsPerMsg": 1,
        "outputs": 1,
        "x": 1110,
        "y": 560,
        "wires": [
            [
                "b123bec7e12bb41e"
            ]
        ]
    },
    {
        "id": "b123bec7e12bb41e",
        "type": "function",
        "z": "0a00ea51f19dcb75",
        "name": "Notify Rule Saved",
        "func": "const saved = msg.payload?.[0];\nreturn {\n    topic: 'ruleSaved',\n    payload: {\n        eui: msg.deviceEui,\n        rule: saved\n    }\n};",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1310,
        "y": 560,
        "wires": [
            [
                "fe9ff61fa70ce0eb"
            ]
        ]
    },
    {
        "id": "0676f7b01b29b217",
        "type": "function",
        "z": "0a00ea51f19dcb75",
        "name": "Prepare Delete",
        "func": "const { eui, ruleId } = msg.payload || {};\nif (!eui || !ruleId) return null;\nmsg.params = [ruleId, eui];\nmsg.deviceEui = eui;\nmsg.ruleId = ruleId;\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 920,
        "y": 620,
        "wires": [
            [
                "fcc1216c32e7b9e3"
            ]
        ]
    },
    {
        "id": "fcc1216c32e7b9e3",
        "type": "postgresql",
        "z": "0a00ea51f19dcb75",
        "name": "Delete Rule",
        "query": "DELETE FROM user_rules WHERE id = $1 AND device_eui = $2",
        "postgreSQLConfig": "pg-config",
        "split": false,
        "rowsPerMsg": 1,
        "outputs": 1,
        "x": 1110,
        "y": 620,
        "wires": [
            [
                "3a342e174936ee0b"
            ]
        ]
    },
    {
        "id": "3a342e174936ee0b",
        "type": "function",
        "z": "0a00ea51f19dcb75",
        "name": "Notify Rule Deleted",
        "func": "return {\n    topic: 'ruleDeleted',\n    payload: {\n        eui: msg.deviceEui,\n        ruleId: msg.ruleId\n    }\n};",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1320,
        "y": 620,
        "wires": [
            [
                "fe9ff61fa70ce0eb"
            ]
        ]
    },
    {
        "id": "e02a55b4e84b228c",
        "type": "function",
        "z": "0a00ea51f19dcb75",
        "name": "Update Trigger",
        "func": "const { eui, triggerKey, enabled } = msg.payload || {};\nif (!eui || !triggerKey || enabled === undefined) return null;\nmsg.params = [enabled, eui, triggerKey];\nmsg.deviceEui = eui;\nmsg.triggerKey = triggerKey;\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 920,
        "y": 680,
        "wires": [
            [
                "e84c3e3544b8cbed"
            ]
        ]
    },
    {
        "id": "e84c3e3544b8cbed",
        "type": "postgresql",
        "z": "0a00ea51f19dcb75",
        "name": "Update Trigger",
        "query": "UPDATE device_triggers SET enabled = $1 WHERE device_eui = $2 AND trigger_key = $3 RETURNING *",
        "postgreSQLConfig": "pg-config",
        "split": false,
        "rowsPerMsg": 1,
        "outputs": 1,
        "x": 1120,
        "y": 680,
        "wires": [
            [
                "55758705f4fc1d63"
            ]
        ]
    },
    {
        "id": "55758705f4fc1d63",
        "type": "function",
        "z": "0a00ea51f19dcb75",
        "name": "Notify Trigger Saved",
        "func": "const saved = msg.payload?.[0];\nreturn {\n    topic: 'triggerSaved',\n    payload: {\n        eui: msg.deviceEui,\n        trigger: saved\n    }\n};",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1330,
        "y": 680,
        "wires": [
            [
                "fe9ff61fa70ce0eb"
            ]
        ]
    },
    {
        "id": "fe9ff61fa70ce0eb",
        "type": "uibuilder",
        "z": "0a00ea51f19dcb75",
        "name": "Dashboard",
        "topic": "",
        "url": "dash",
        "okToGo": true,
        "fwdInMessages": false,
        "allowScripts": false,
        "allowStyles": false,
        "copyIndex": true,
        "templateFolder": "ext-svelte",
        "extTemplate": "TotallyInformation/uib-template-svelte-simple",
        "showfolder": false,
        "reload": false,
        "sourceFolder": "src",
        "deployedVersion": "7.5.0",
        "showMsgUib": false,
        "title": "",
        "descr": "",
        "editurl": "vscode://vscode-remote/ssh-remote+farm/data/uibuilder/dash/?windowId=_blank",
        "x": 460,
        "y": 200,
        "wires": [
            [
                "1961d947f0695190"
            ],
            [
                "f7bbe8cc31a3dbbd"
            ]
        ]
    },
    {
        "id": "d1b95fed578f33c0",
        "type": "mqtt in",
        "z": "7e7308018823ce78",
        "name": "ChirpStack Uplinks",
        "topic": "application/+/device/+/event/up",
        "qos": "0",
        "datatype": "json",
        "broker": "e1b2c3d4e5f6a7b8",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 130,
        "y": 380,
        "wires": [
            [
                "a1bc98544f61aa96"
            ]
        ]
    },
    {
        "id": "a1bc98544f61aa96",
        "type": "function",
        "z": "7e7308018823ce78",
        "name": "Extract Device Info",
        "func": "// Extract device info and fPort from ChirpStack v4 event\nconst deviceEui = msg.payload.deviceInfo?.devEui || 'unknown';\nconst deviceName = msg.payload.deviceInfo?.deviceName || '';\nconst fPort = msg.payload.fPort || 2; // Default to telemetry\n\n// Get decoded data\nlet data = msg.payload.object || {};\n\n// Add metadata\nconst rssi = msg.payload.rxInfo?.[0]?.rssi;\nconst snr = msg.payload.rxInfo?.[0]?.snr;\n\nmsg.deviceEui = deviceEui;\nmsg.deviceName = deviceName;\nmsg.fPort = fPort;\nmsg.data = data;\nmsg.rssi = rssi;\nmsg.snr = snr;\nmsg.rawPayload = msg.payload;\n\nnode.status({fill: 'green', shape: 'dot', text: `${deviceEui.slice(-4)} fPort:${fPort}`});\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 350,
        "y": 380,
        "wires": [
            [
                "5f5b19ca44b4888f",
                "44bc74729bfdd453"
            ]
        ]
    },
    {
        "id": "44bc74729bfdd453",
        "type": "debug",
        "z": "7e7308018823ce78",
        "name": "Raw Messages",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "x": 600,
        "y": 240,
        "wires": []
    },
    {
        "id": "5f5b19ca44b4888f",
        "type": "switch",
        "z": "7e7308018823ce78",
        "name": "Route by fPort",
        "property": "fPort",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "1",
                "vt": "num"
            },
            {
                "t": "eq",
                "v": "2",
                "vt": "num"
            },
            {
                "t": "eq",
                "v": "3",
                "vt": "num"
            },
            {
                "t": "eq",
                "v": "4",
                "vt": "num"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 5,
        "x": 560,
        "y": 380,
        "wires": [
            [
                "06ad1ed1d647a35e"
            ],
            [
                "ed7fa461dc727bcf"
            ],
            [
                "783b8a1e1f606267"
            ],
            [
                "d3da543618bdb360"
            ],
            [
                "ed7fa461dc727bcf"
            ]
        ]
    },
    {
        "id": "06ad1ed1d647a35e",
        "type": "function",
        "z": "7e7308018823ce78",
        "name": "Registration Handler (fPort 1)",
        "func": "// Parse registration message from device\nconst deviceEui = msg.deviceEui;\nconst reg = msg.data;\n\nif (!reg || !reg.fields) {\n    node.warn('Invalid registration: missing fields');\n    return null;\n}\n\n// Store full registration\nmsg.registration = reg;\n\n// Prepare device upsert (msg.params for PostgreSQL node)\nmsg.params = [\n    deviceEui,\n    msg.deviceName || reg.type || 'Unknown',\n    reg.type || 'unknown',\n    reg.fw || '0.0.0',\n    JSON.stringify(reg)\n];\n\nnode.status({fill: 'blue', shape: 'dot', text: `Registered: ${deviceEui.slice(-4)}`});\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 860,
        "y": 280,
        "wires": [
            [
                "36cedf9b94a2fa16"
            ]
        ]
    },
    {
        "id": "36cedf9b94a2fa16",
        "type": "postgresql",
        "z": "7e7308018823ce78",
        "name": "Upsert Device",
        "query": "INSERT INTO devices (device_eui, device_name, device_type, firmware_version, registration)\nVALUES ($1, $2, $3, $4, $5::jsonb)\nON CONFLICT (device_eui) DO UPDATE SET\n    device_name = EXCLUDED.device_name,\n    device_type = EXCLUDED.device_type,\n    firmware_version = EXCLUDED.firmware_version,\n    registration = EXCLUDED.registration,\n    last_seen = NOW()\nRETURNING device_eui",
        "postgreSQLConfig": "pg-config",
        "split": false,
        "rowsPerMsg": 1,
        "outputs": 1,
        "x": 1100,
        "y": 280,
        "wires": [
            [
                "6f07ab39d8e37374",
                "a3ca1449ca2f1388"
            ]
        ]
    },
    {
        "id": "a3ca1449ca2f1388",
        "type": "function",
        "z": "7e7308018823ce78",
        "name": "Send Registration ACK",
        "func": "// Build ChirpStack downlink to acknowledge registration\nconst deviceEui = msg.deviceEui;\n\n// ChirpStack v4 downlink via MQTT\nconst appId = global.get('chirpstackAppId') || '885c4dd2-e474-4265-bd25-2f838571f8de';\n\nmsg.topic = `application/${appId}/device/${deviceEui}/command/down`;\nmsg.payload = {\n    devEui: deviceEui,\n    confirmed: false,\n    fPort: 5,\n    data: 'AQ=='  // 0x01 byte, base64 encoded\n};\n\nnode.status({fill: 'green', shape: 'dot', text: `ACK: ${deviceEui.slice(-4)}`});\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1320,
        "y": 180,
        "wires": [
            [
                "4e14998ffcae6e07"
            ]
        ]
    },
    {
        "id": "4e14998ffcae6e07",
        "type": "mqtt out",
        "z": "7e7308018823ce78",
        "name": "Send Reg ACK Downlink",
        "topic": "",
        "qos": "",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "e1b2c3d4e5f6a7b8",
        "x": 1610,
        "y": 180,
        "wires": []
    },
    {
        "id": "6f07ab39d8e37374",
        "type": "function",
        "z": "7e7308018823ce78",
        "name": "Parse & Store Fields",
        "func": "const deviceEui = msg.deviceEui;\nconst reg = msg.registration;\n\n// Build batch inserts for fields, controls, triggers\nconst fields = reg.fields || [];\nconst triggers = reg.triggers || [];\nconst cmds = reg.cmds || [];\n\n// Delete existing and re-insert (simpler than upsert for arrays)\nmsg.params = [deviceEui];\n\n// Deduplicate helper - keep last occurrence of each key\nconst dedup = (arr, keyFn) => {\n    const map = new Map();\n    arr.forEach(item => map.set(keyFn(item), item));\n    return Array.from(map.values());\n};\n\n// Prepare field inserts (deduplicated by field_key)\nmsg.fieldRows = dedup(fields.map(f => ({\n    device_eui: deviceEui,\n    field_key: f.k,\n    display_name: f.n,\n    data_type: f.t,\n    unit: f.u || null,\n    category: f.c,\n    min_value: f.min ?? null,\n    max_value: f.max ?? null,\n    enum_values: f.v ? JSON.stringify(f.v) : null\n})), r => r.field_key);\n\n// Prepare control inserts (for state fields, deduplicated by control_key)\nmsg.controlRows = dedup(fields\n    .filter(f => f.c === 'state')\n    .map(f => ({\n        device_eui: deviceEui,\n        control_key: f.k,\n        current_state: f.v ? f.v[0] : 'off',\n        mode: 'auto'\n    })), r => r.control_key);\n\n// Prepare trigger inserts (deduplicated by trigger_key)\nmsg.triggerRows = dedup(triggers.map(t => ({\n    device_eui: deviceEui,\n    trigger_key: t.k,\n    display_name: t.n,\n    field_key: t.f,\n    operator: t.op,\n    threshold: t.th,\n    action_control: t.ctrl,\n    action_state: t.st,\n    enabled: true\n})), r => r.trigger_key);\n\n// Infer viz_config defaults (deduplicated by field_key)\nmsg.vizRows = dedup(fields.map(f => {\n    let vizType = 'badge';\n    let gaugeStyle = null;\n    let chartColor = '#3b82f6';\n    let sortOrder = 100;\n    \n    if (f.c === 'state') {\n        vizType = 'toggle';\n    } else if (f.t === 'num' && f.c === 'cont') {\n        vizType = (f.min !== undefined && f.max !== undefined) ? 'both' : 'chart';\n        gaugeStyle = 'radial';\n        \n        // Special cases by field key\n        const key = f.k.toLowerCase();\n        if (key.includes('level') || key.includes('tank') || key === 'wl') {\n            gaugeStyle = 'liquid';\n            chartColor = '#3b82f6';\n            sortOrder = 10;\n        } else if (key.includes('battery') || key === 'bp') {\n            chartColor = '#10b981';\n            sortOrder = 20;\n        } else if (key.includes('rssi')) {\n            chartColor = '#f59e0b';\n            sortOrder = 80;\n        } else if (key.includes('snr')) {\n            chartColor = '#8b5cf6';\n            sortOrder = 90;\n        }\n    }\n    \n    // Default thresholds for bounded numeric\n    let thresholds = null;\n    if (f.t === 'num' && f.min !== undefined && f.max !== undefined) {\n        thresholds = JSON.stringify([\n            {pct: 0.2, color: '#ef4444'},\n            {pct: 0.5, color: '#f59e0b'},\n            {pct: 1.0, color: '#10b981'}\n        ]);\n    }\n    \n    return {\n        device_eui: deviceEui,\n        field_key: f.k,\n        viz_type: vizType,\n        gauge_style: gaugeStyle,\n        chart_color: chartColor,\n        thresholds: thresholds,\n        is_visible: true,\n        sort_order: sortOrder\n    };\n}), r => r.field_key);\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1300,
        "y": 280,
        "wires": [
            [
                "50db4638a39fc128"
            ]
        ]
    },
    {
        "id": "50db4638a39fc128",
        "type": "function",
        "z": "7e7308018823ce78",
        "name": "Insert Fields",
        "func": "// Build INSERT for fields\nif (msg.fieldRows.length === 0) return msg;\n\nconst values = msg.fieldRows.map((r, i) => {\n    const offset = i * 9;\n    return `($${offset+1}, $${offset+2}, $${offset+3}, $${offset+4}, $${offset+5}, $${offset+6}, $${offset+7}, $${offset+8}, $${offset+9}::jsonb)`;\n}).join(',\\n');\n\nmsg.query = `INSERT INTO device_fields \n(device_eui, field_key, display_name, data_type, unit, category, min_value, max_value, enum_values)\nVALUES ${values}\nON CONFLICT (device_eui, field_key) DO UPDATE SET\ndisplay_name = EXCLUDED.display_name,\ndata_type = EXCLUDED.data_type,\nunit = EXCLUDED.unit,\ncategory = EXCLUDED.category,\nmin_value = EXCLUDED.min_value,\nmax_value = EXCLUDED.max_value,\nenum_values = EXCLUDED.enum_values`;\n\nmsg.params = msg.fieldRows.flatMap(r => [\n    r.device_eui, r.field_key, r.display_name, r.data_type,\n    r.unit, r.category, r.min_value, r.max_value, r.enum_values\n]);\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 2110,
        "y": 280,
        "wires": [
            [
                "84fb6f0483dda5d8"
            ]
        ]
    },
    {
        "id": "84fb6f0483dda5d8",
        "type": "postgresql",
        "z": "7e7308018823ce78",
        "name": "Execute",
        "query": "",
        "postgreSQLConfig": "pg-config",
        "split": false,
        "rowsPerMsg": 1,
        "outputs": 1,
        "x": 2300,
        "y": 280,
        "wires": [
            [
                "c342a88d0274bc59"
            ]
        ]
    },
    {
        "id": "c342a88d0274bc59",
        "type": "function",
        "z": "7e7308018823ce78",
        "name": "Insert Controls",
        "func": "if (msg.controlRows.length === 0) return msg;\n\nconst values = msg.controlRows.map((r, i) => {\n    const offset = i * 4;\n    return `($${offset+1}, $${offset+2}, $${offset+3}, $${offset+4})`;\n}).join(',\\n');\n\nmsg.query = `INSERT INTO device_controls \n(device_eui, control_key, current_state, mode)\nVALUES ${values}\nON CONFLICT (device_eui, control_key) DO UPDATE SET\ncurrent_state = EXCLUDED.current_state,\nmode = EXCLUDED.mode`;\n\nmsg.params = msg.controlRows.flatMap(r => [\n    r.device_eui, r.control_key, r.current_state, r.mode\n]);\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 2470,
        "y": 280,
        "wires": [
            [
                "a0dceda4f7856111"
            ]
        ]
    },
    {
        "id": "a0dceda4f7856111",
        "type": "postgresql",
        "z": "7e7308018823ce78",
        "name": "Execute",
        "query": "",
        "postgreSQLConfig": "pg-config",
        "split": false,
        "rowsPerMsg": 1,
        "outputs": 1,
        "x": 2640,
        "y": 280,
        "wires": [
            [
                "7361cf7c736b052a"
            ]
        ]
    },
    {
        "id": "7361cf7c736b052a",
        "type": "function",
        "z": "7e7308018823ce78",
        "name": "Insert Triggers",
        "func": "if (msg.triggerRows.length === 0) return msg;\n\nconst values = msg.triggerRows.map((r, i) => {\n    const offset = i * 9;\n    return `($${offset+1}, $${offset+2}, $${offset+3}, $${offset+4}, $${offset+5}, $${offset+6}, $${offset+7}, $${offset+8}, $${offset+9})`;\n}).join(',\\n');\n\nmsg.query = `INSERT INTO device_triggers \n(device_eui, trigger_key, display_name, field_key, operator, threshold, action_control, action_state, enabled)\nVALUES ${values}\nON CONFLICT (device_eui, trigger_key) DO UPDATE SET\n    display_name = EXCLUDED.display_name,\n    field_key = EXCLUDED.field_key,\n    operator = EXCLUDED.operator,\n    threshold = EXCLUDED.threshold,\n    action_control = EXCLUDED.action_control,\n    action_state = EXCLUDED.action_state,\n    enabled = EXCLUDED.enabled`;\n\nmsg.params = msg.triggerRows.flatMap(r => [\n    r.device_eui, r.trigger_key, r.display_name, r.field_key,\n    r.operator, r.threshold, r.action_control, r.action_state, r.enabled\n]);\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 2830,
        "y": 280,
        "wires": [
            [
                "a12fcd8d731d31b8"
            ]
        ]
    },
    {
        "id": "a12fcd8d731d31b8",
        "type": "postgresql",
        "z": "7e7308018823ce78",
        "name": "Execute",
        "query": "",
        "postgreSQLConfig": "pg-config",
        "split": false,
        "rowsPerMsg": 1,
        "outputs": 1,
        "x": 2990,
        "y": 280,
        "wires": [
            [
                "119fba13945adb8c"
            ]
        ]
    },
    {
        "id": "119fba13945adb8c",
        "type": "function",
        "z": "7e7308018823ce78",
        "name": "Upsert Viz Config",
        "func": "if (msg.vizRows.length === 0) return msg;\n\nconst values = msg.vizRows.map((r, i) => {\n    const offset = i * 8;\n    return `($${offset+1}, $${offset+2}, $${offset+3}, $${offset+4}, $${offset+5}, $${offset+6}::jsonb, $${offset+7}, $${offset+8})`;\n}).join(',\\n');\n\nmsg.query = `INSERT INTO viz_config \n(device_eui, field_key, viz_type, gauge_style, chart_color, thresholds, is_visible, sort_order)\nVALUES ${values}\nON CONFLICT (device_eui, field_key) DO UPDATE SET\n    viz_type = COALESCE(viz_config.viz_type, EXCLUDED.viz_type),\n    gauge_style = COALESCE(viz_config.gauge_style, EXCLUDED.gauge_style),\n    chart_color = COALESCE(viz_config.chart_color, EXCLUDED.chart_color)`;\n\nmsg.params = msg.vizRows.flatMap(r => [\n    r.device_eui, r.field_key, r.viz_type, r.gauge_style,\n    r.chart_color, r.thresholds, r.is_visible, r.sort_order\n]);\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 3180,
        "y": 280,
        "wires": [
            [
                "0c6f8ced1f6b2d1c"
            ]
        ]
    },
    {
        "id": "0c6f8ced1f6b2d1c",
        "type": "postgresql",
        "z": "7e7308018823ce78",
        "name": "Execute",
        "query": "",
        "postgreSQLConfig": "pg-config",
        "split": false,
        "rowsPerMsg": 1,
        "outputs": 1,
        "x": 3360,
        "y": 280,
        "wires": [
            [
                "66c1bffb93d6651d"
            ]
        ]
    },
    {
        "id": "66c1bffb93d6651d",
        "type": "function",
        "z": "7e7308018823ce78",
        "name": "Notify UI",
        "func": "// Send registration notification to UI\nreturn {\n    topic: 'deviceRegistered',\n    payload: {\n        eui: msg.deviceEui,\n        name: msg.deviceName,\n        type: msg.registration.type,\n        firmware: msg.registration.fw\n    }\n};",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 3540,
        "y": 280,
        "wires": [
            []
        ]
    },
    {
        "id": "ed7fa461dc727bcf",
        "type": "function",
        "z": "7e7308018823ce78",
        "name": "Telemetry Handler (fPort 2)",
        "func": "// Process telemetry data\nconst deviceEui = msg.deviceEui;\nconst data = msg.data;\n\n// Prepare telemetry insert (msg.params for PostgreSQL node)\nmsg.params = [\n    deviceEui,\n    JSON.stringify(data),\n    msg.rssi,\n    msg.snr\n];\n\nnode.status({fill: 'green', shape: 'dot', text: `Telemetry: ${deviceEui.slice(-4)}`});\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 860,
        "y": 460,
        "wires": [
            [
                "3737949cca34c751",
                "d8e9934b853d9ac8"
            ]
        ]
    },
    {
        "id": "3737949cca34c751",
        "type": "postgresql",
        "z": "7e7308018823ce78",
        "name": "Store Telemetry",
        "query": "INSERT INTO telemetry (device_eui, data, rssi, snr) VALUES ($1, $2::jsonb, $3, $4) RETURNING id",
        "postgreSQLConfig": "pg-config",
        "split": false,
        "rowsPerMsg": 1,
        "outputs": 1,
        "x": 1110,
        "y": 460,
        "wires": [
            [
                "2638c0b94e884a39"
            ]
        ]
    },
    {
        "id": "d8e9934b853d9ac8",
        "type": "postgresql",
        "z": "7e7308018823ce78",
        "name": "Update Last Seen",
        "query": "UPDATE devices SET last_seen = NOW() WHERE device_eui = $1",
        "postgreSQLConfig": "pg-config",
        "split": false,
        "rowsPerMsg": 1,
        "outputs": 1,
        "x": 1130,
        "y": 520,
        "wires": [
            []
        ]
    },
    {
        "id": "2638c0b94e884a39",
        "type": "function",
        "z": "7e7308018823ce78",
        "name": "Update Controls from Telemetry",
        "func": "// Update device_controls with state values from telemetry\nconst deviceEui = msg.deviceEui;\nconst data = msg.data;\n\n// Get state fields from context (or query later)\n// For now, check common state fields\nconst stateFields = ['pump', 'valve'];\nconst updates = [];\n\nfor (const key of stateFields) {\n    if (data[key] !== undefined) {\n        updates.push({ control_key: key, state: data[key] });\n    }\n}\n\nif (updates.length === 0) {\n    // No state updates, proceed to push telemetry\n    return [msg, null];\n}\n\nmsg.stateUpdates = updates;\nreturn [msg, msg];",
        "outputs": 2,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1350,
        "y": 460,
        "wires": [
            [
                "ebeb53a7d2ebd90d"
            ],
            [
                "3625a9e18829b23e"
            ]
        ]
    },
    {
        "id": "3625a9e18829b23e",
        "type": "function",
        "z": "7e7308018823ce78",
        "name": "Build Control Updates",
        "func": "const deviceEui = msg.deviceEui;\nconst updates = msg.stateUpdates;\n\n// Build update query for each control\nconst cases = updates.map((u, i) => \n    `WHEN control_key = $${i*2+2} THEN $${i*2+3}`\n).join(' ');\n\nconst keys = updates.map(u => u.control_key);\n\nmsg.query = `UPDATE device_controls \nSET current_state = CASE ${cases} END,\n    last_change_at = NOW()\nWHERE device_eui = $1 AND control_key IN (${keys.map((_, i) => `$${i*2+2}`).join(', ')})`;\n\nmsg.params = [deviceEui, ...updates.flatMap(u => [u.control_key, u.state])];\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1600,
        "y": 520,
        "wires": [
            [
                "1d12445185b13be9"
            ]
        ]
    },
    {
        "id": "1d12445185b13be9",
        "type": "postgresql",
        "z": "7e7308018823ce78",
        "name": "Execute",
        "query": "",
        "postgreSQLConfig": "pg-config",
        "split": false,
        "rowsPerMsg": 1,
        "outputs": 1,
        "x": 1820,
        "y": 520,
        "wires": [
            []
        ]
    },
    {
        "id": "ebeb53a7d2ebd90d",
        "type": "function",
        "z": "7e7308018823ce78",
        "name": "Push to UI",
        "func": "return {\n    topic: 'telemetry',\n    payload: {\n        eui: msg.deviceEui,\n        data: msg.data,\n        rssi: msg.rssi,\n        snr: msg.snr,\n        ts: new Date().toISOString()\n    }\n};",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1580,
        "y": 460,
        "wires": [
            [
                "1edd34bc2dab0ea3"
            ]
        ]
    },
    {
        "id": "1edd34bc2dab0ea3",
        "type": "function",
        "z": "7e7308018823ce78",
        "name": "Prepare Rules Query",
        "func": "// Prepare query for user rules\nmsg.params = [msg.payload.eui];\nmsg.telemetryData = msg.payload.data;\nmsg.deviceEui = msg.payload.eui;\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1840,
        "y": 460,
        "wires": [
            [
                "c667ecaf2b954a2e"
            ]
        ]
    },
    {
        "id": "c667ecaf2b954a2e",
        "type": "postgresql",
        "z": "7e7308018823ce78",
        "name": "Get User Rules",
        "query": "SELECT r.*, c.current_state, c.mode, c.manual_until\nFROM user_rules r\nLEFT JOIN device_controls c ON r.device_eui = c.device_eui AND r.action_control = c.control_key\nWHERE r.device_eui = $1 AND r.enabled = true",
        "postgreSQLConfig": "pg-config",
        "split": false,
        "rowsPerMsg": 1,
        "outputs": 1,
        "x": 2040,
        "y": 460,
        "wires": [
            [
                "ce3a52914447fd2a"
            ]
        ]
    },
    {
        "id": "ce3a52914447fd2a",
        "type": "function",
        "z": "7e7308018823ce78",
        "name": "Evaluate Rules",
        "func": "const rules = msg.payload || [];\nconst data = msg.telemetryData;\nconst deviceEui = msg.deviceEui;\n\nif (!rules.length || !data) return null;\n\n// Operator functions\nconst ops = {\n    '<': (a, b) => a < b,\n    '>': (a, b) => a > b,\n    '<=': (a, b) => a <= b,\n    '>=': (a, b) => a >= b,\n    '=': (a, b) => a == b,\n    '==': (a, b) => a == b,\n    '!=': (a, b) => a != b\n};\n\nconst now = Date.now();\nconst triggeredRules = [];\n\nfor (const rule of rules) {\n    // Check cooldown\n    if (rule.last_triggered) {\n        const elapsed = (now - new Date(rule.last_triggered).getTime()) / 1000;\n        if (elapsed < (rule.cooldown_seconds || 300)) {\n            continue;\n        }\n    }\n\n    // Check if control is in manual mode\n    if (rule.mode === 'manual') {\n        if (!rule.manual_until || new Date(rule.manual_until) > new Date()) {\n            continue; // Still in manual mode\n        }\n    }\n\n    // Parse condition\n    const condition = rule.condition;\n    if (!condition || !condition.field || !condition.op) continue;\n\n    const fieldValue = data[condition.field];\n    if (fieldValue === undefined) continue;\n\n    const op = ops[condition.op];\n    if (!op) continue;\n\n    // Evaluate condition\n    if (op(fieldValue, condition.val)) {\n        // Rule triggered!\n        triggeredRules.push({\n            ruleId: rule.id,\n            ruleName: rule.name,\n            control: rule.action_control,\n            state: rule.action_state,\n            reason: `rule:${rule.id}`\n        });\n    }\n}\n\nif (triggeredRules.length === 0) return null;\n\n// For now, take first triggered rule (could add priority handling)\nconst triggered = triggeredRules[0];\nmsg.triggeredRule = triggered;\nmsg.ruleParams = [triggered.ruleId];\n\nnode.status({fill: 'yellow', shape: 'dot', text: `Rule: ${triggered.ruleName}`});\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 2220,
        "y": 460,
        "wires": [
            [
                "5c3e697b051fa223",
                "a1622c9b7b8d4431"
            ]
        ]
    },
    {
        "id": "5c3e697b051fa223",
        "type": "postgresql",
        "z": "7e7308018823ce78",
        "name": "Update Rule Triggered",
        "query": "UPDATE user_rules SET last_triggered = NOW() WHERE id = $1",
        "postgreSQLConfig": "pg-config",
        "split": false,
        "rowsPerMsg": 1,
        "outputs": 1,
        "x": 2440,
        "y": 460,
        "wires": [
            []
        ]
    },
    {
        "id": "a1622c9b7b8d4431",
        "type": "function",
        "z": "7e7308018823ce78",
        "name": "Build Rule Downlink",
        "func": "const triggered = msg.triggeredRule;\nconst deviceEui = msg.deviceEui;\n\n// Command ports by control type\nconst commandPorts = { 'pump': 20, 'valve': 21 };\nconst port = commandPorts[triggered.control] || 20;\nconst stateValue = (triggered.state === 'on' || triggered.state === 'open') ? 0x01 : 0x00;\n\n// Prepare command log\nmsg.cmdParams = [\n    deviceEui,\n    `set_${triggered.control}`,\n    JSON.stringify({ state: triggered.state }),\n    triggered.reason,\n    'sent'\n];\n\n// Build downlink\nconst appId = global.get('chirpstackAppId') || '885c4dd2-e474-4265-bd25-2f838571f8de';\nmsg.topic = `application/${appId}/device/${deviceEui}/command/down`;\nmsg.payload = {\n    devEui: deviceEui,\n    confirmed: false,\n    fPort: port,\n    data: Buffer.from([stateValue]).toString('base64')\n};\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 2440,
        "y": 400,
        "wires": [
            [
                "c945c880f45e550e",
                "4018fc1d8b2ad263"
            ]
        ]
    },
    {
        "id": "c945c880f45e550e",
        "type": "postgresql",
        "z": "7e7308018823ce78",
        "name": "Log Command",
        "query": "INSERT INTO commands (device_eui, command_key, payload, initiated_by, status, sent_at)\nVALUES ($1, $2, $3::jsonb, $4, $5, NOW())",
        "postgreSQLConfig": "pg-config",
        "split": false,
        "rowsPerMsg": 1,
        "outputs": 1,
        "x": 2680,
        "y": 340,
        "wires": [
            []
        ]
    },
    {
        "id": "4018fc1d8b2ad263",
        "type": "mqtt out",
        "z": "7e7308018823ce78",
        "name": "Send Rule Downlink",
        "topic": "",
        "qos": "",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "e1b2c3d4e5f6a7b8",
        "x": 2700,
        "y": 400,
        "wires": []
    },
    {
        "id": "783b8a1e1f606267",
        "type": "function",
        "z": "7e7308018823ce78",
        "name": "State Change Handler (fPort 3)",
        "func": "// Process state change event from device\nconst deviceEui = msg.deviceEui;\nconst data = msg.data;\n\nconst controlKey = data.control || data.ctrl;\nconst newState = data.state || data.st;\nconst reason = data.reason || 'device';\nconst deviceTs = data.ts ? new Date(data.ts * 1000) : null;\n\nif (!controlKey || !newState) {\n    node.warn('Invalid state change: missing control or state');\n    return null;\n}\n\nmsg.stateChange = {\n    control_key: controlKey,\n    new_state: newState,\n    reason: reason,\n    device_ts: deviceTs\n};\n\nmsg.stateParams = [deviceEui, controlKey];\n\nnode.status({fill: 'yellow', shape: 'dot', text: `${controlKey}: ${newState}`});\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 870,
        "y": 580,
        "wires": [
            [
                "70e4763f19d63008"
            ]
        ]
    },
    {
        "id": "70e4763f19d63008",
        "type": "postgresql",
        "z": "7e7308018823ce78",
        "name": "Get Old State",
        "query": "SELECT current_state FROM device_controls WHERE device_eui = $1 AND control_key = $2",
        "postgreSQLConfig": "pg-config",
        "split": false,
        "rowsPerMsg": 1,
        "outputs": 1,
        "x": 1110,
        "y": 580,
        "wires": [
            [
                "b3fcb841ba2153ea"
            ]
        ]
    },
    {
        "id": "b3fcb841ba2153ea",
        "type": "function",
        "z": "7e7308018823ce78",
        "name": "Insert State Change",
        "func": "const oldState = msg.payload?.[0]?.current_state || null;\nconst sc = msg.stateChange;\n\nmsg.insertParams = [\n    msg.deviceEui,\n    sc.control_key,\n    oldState,\n    sc.new_state,\n    sc.reason,\n    sc.device_ts\n];\n\nmsg.updateParams = [\n    sc.new_state,\n    sc.reason,\n    msg.deviceEui,\n    sc.control_key\n];\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1320,
        "y": 580,
        "wires": [
            [
                "b5c521a6b9aa691e"
            ]
        ]
    },
    {
        "id": "b5c521a6b9aa691e",
        "type": "postgresql",
        "z": "7e7308018823ce78",
        "name": "Log State Change",
        "query": "INSERT INTO state_changes (device_eui, control_key, old_state, new_state, reason, device_ts)\nVALUES ($1, $2, $3, $4, $5, $6)",
        "postgreSQLConfig": "pg-config",
        "split": false,
        "rowsPerMsg": 1,
        "outputs": 1,
        "x": 1540,
        "y": 580,
        "wires": [
            [
                "1b0fa593fb91b2bb"
            ]
        ]
    },
    {
        "id": "1b0fa593fb91b2bb",
        "type": "postgresql",
        "z": "7e7308018823ce78",
        "name": "Update Control",
        "query": "UPDATE device_controls SET current_state = $1, last_change_at = NOW(), last_change_by = $2\nWHERE device_eui = $3 AND control_key = $4",
        "postgreSQLConfig": "pg-config",
        "split": false,
        "rowsPerMsg": 1,
        "outputs": 1,
        "x": 1760,
        "y": 580,
        "wires": [
            [
                "f4249380616008ba"
            ]
        ]
    },
    {
        "id": "f4249380616008ba",
        "type": "function",
        "z": "7e7308018823ce78",
        "name": "Push to UI",
        "func": "const sc = msg.stateChange;\nreturn {\n    topic: 'stateChange',\n    payload: {\n        eui: msg.deviceEui,\n        control: sc.control_key,\n        state: sc.new_state,\n        reason: sc.reason\n    }\n};",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1970,
        "y": 580,
        "wires": [
            []
        ]
    },
    {
        "id": "d3da543618bdb360",
        "type": "function",
        "z": "7e7308018823ce78",
        "name": "Command ACK Handler (fPort 4)",
        "func": "// Process command acknowledgment from device\nconst deviceEui = msg.deviceEui;\nconst data = msg.data;\n\nconst cmdId = data.cmd_id || data.id;\nconst status = data.status || 'acked';\n\nif (!cmdId) {\n    node.warn('Invalid ACK: missing cmd_id');\n    return null;\n}\n\nmsg.ackParams = [status, cmdId, deviceEui];\n\nnode.status({fill: 'green', shape: 'dot', text: `ACK: ${cmdId}`});\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 880,
        "y": 660,
        "wires": [
            [
                "f85a19c454be9423"
            ]
        ]
    },
    {
        "id": "f85a19c454be9423",
        "type": "postgresql",
        "z": "7e7308018823ce78",
        "name": "Update Command Status",
        "query": "UPDATE commands SET status = $1, acked_at = NOW() WHERE id = $2 AND device_eui = $3",
        "postgreSQLConfig": "pg-config",
        "split": false,
        "rowsPerMsg": 1,
        "outputs": 1,
        "x": 1150,
        "y": 660,
        "wires": [
            [
                "acf8fced0ec59e45"
            ]
        ]
    },
    {
        "id": "acf8fced0ec59e45",
        "type": "function",
        "z": "7e7308018823ce78",
        "name": "Push to UI",
        "func": "return {\n    topic: 'commandAck',\n    payload: {\n        eui: msg.deviceEui,\n        commandId: msg.ackParams[1],\n        status: msg.ackParams[0]\n    }\n};",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1350,
        "y": 660,
        "wires": [
            []
        ]
    }
]